!function(e){"function"==typeof define&&define.amd?define(["fs"],e):e()}((function(){"use strict";class e{static i=1;static o=2;static u=3;static p=4;static R=5;static T=6;static $=7;static k=8;static O=9;static I=10;static P=11;static _=12;static A=13;static N=14;static S=15;static U=16;static D=17;static M=18;static C=19;constructor(e,t,r,n){this.type=e,this.name=t,this.value=r,this.position=n}static Y(t){return Object.entries(e).filter((([e,r])=>r===t))[0][0]}}class t{static L=18;static PI=new t("3.141592653589793238");static ZERO=new t("0");static#e=BigInt("1"+"0".repeat(t.L));static#t=new RegExp("\\.?0+$");#r;constructor(e=0){let r,n;e instanceof t?this.#r=e.#r:e instanceof BigInt?this.#r=value*t.#e:([r,n]=(e+".").split("."),this.#r=BigInt(r+n.substr(0,t.L).padEnd(t.L,"0")),n.charCodeAt(t.L)>52&&this.#r++)}#n(e){let r;return r=new t(this),r.#r=e,r}#a(e,t){return this.#n(e/t+2n*e/t%2n)}add(e){return this.#n(this.#r+new t(e).#r)}B(e){return this.#n(this.#r-new t(e).#r)}F(e){return this.#a(this.#r*new t(e).#r,t.#e)}V(e){return this.#a(this.#r*t.#e,new t(e).#r)}equals(e){return this.valueOf()==e}valueOf(){return this.#r}W(){return+this.toString()}toString(e=t.L){let r;return r=this.#a(this.#r,BigInt("1"+"0".repeat(e>-1?Math.max(t.L-e,0):t.L))).#r.toString(),r=r.startsWith("-")?"-"+r.substr(1).padStart(e+1,"0"):r.padStart(e+1,"0"),r.substr(0,r.length-e)+("."+r.substr(-e)).replace(t.#t,"")}}class r{static X=1;static H=2;static j=3;static K=4;static G=5;static Z(){return{stack:[],J:[],ee:null,pending:0,x:t.ZERO,y:t.ZERO,te:!1,re:null,ne:t.ZERO,ae:t.ZERO}}}class n{static#i=[{type:e.i,ie:new RegExp("^[0-9]*\\.?[0-9]+",""),se:e=>new t(e)},{type:e.o,ie:new RegExp("^[achlmqstvz](?![a-z_$])","i"),se:e=>({a:[r.X,r.H,r.j,r.K,r.K,r.X,r.H],c:[r.X,r.H,r.X,r.H,r.X,r.H],h:[r.X],l:[r.X,r.H],m:[r.X,r.H],q:[r.X,r.H,r.X,r.H],s:[r.X,r.H,r.X,r.H],t:[r.X,r.H],v:[r.H],z:[]}[e.toLowerCase()])},{type:e.u,ie:new RegExp("^,+",""),se:()=>null},{type:e.p,ie:new RegExp("^\\s+",""),se:()=>null},{type:e.R,ie:new RegExp("^[a-z_$][a-z0-9_$]*","i"),se:e=>e},{type:e.T,ie:new RegExp("^[()]",""),se:e=>"("===e},{type:e.k,ie:new RegExp("^\\+",""),se:e=>e},{type:e.I,ie:new RegExp("^\\*",""),se:e=>e},{type:e.O,ie:new RegExp("^-",""),se:e=>e},{type:e.P,ie:new RegExp("^/",""),se:e=>e},{type:e._,ie:new RegExp("^%r",""),se:e=>e},{type:e.A,ie:new RegExp("^%h",""),se:e=>e},{type:e.N,ie:new RegExp("^%v",""),se:e=>e},{type:e.S,ie:new RegExp("^%o",""),se:e=>e},{type:e.U,ie:new RegExp("^@",""),se:e=>e},{type:e.D,ie:new RegExp("^\\|",""),se:e=>e},{type:e.M,ie:new RegExp("^=",""),se:e=>e},{type:e.C,ie:new RegExp("^#",""),se:e=>e}];#s=null;#o=0;constructor(t){var r,a,i,s;for(this.#s=[],a=0;t.length;){for(r=0;r<n.#i.length;r++)if(i=(s=n.#i[r]).ie.exec(t)){this.#s.push(new e(s.type,i[0],s.se(i[0]),a)),a+=i[0].length,t=t.substr(i[0].length);break}if(r===n.#i.length)throw new SyntaxError(`Unexpected symbol "${t.substr(0,1)}" at column ${a}`)}this.#s.push(new e(e.$,null,null,a))}oe(){return this.#s[this.#o]??null}ce(){return this.#o++,this.oe()}le(){return this.#s[this.#o+1]??null}reset(){return this.#o=0,this.oe()}}class a{static he=1;static ue=2;static fe=3;static pe=4;constructor(e,t){this.type=e,this.value=t}#c(){return{[a.he]:"Rotate",[a.ue]:"Vertical skew",[a.fe]:"Horizontal skew",[a.pe]:"Reverse order"}[this.type]??"Unknown"}toString(){return`${this.#c()}: ${this.value}`}me(e,t,r,n){let i,s;switch(this.type){case a.he:let o,c;r=r.B(e),n=n.B(t),s=this.value.W()%360*Math.PI/180,o=Math.cos(s),c=Math.sin(s),Math.abs(o-c)<2*Number.EPSILON?c=o:Math.abs(o+c)<2*Number.EPSILON&&(o=c),Math.abs(o)<Number.EPSILON&&(o=0),Math.abs(c)<Number.EPSILON&&(c=0),i={x:e.add(r.F(o)).B(n.F(c)),y:t.add(n.F(o)).add(r.F(c))};break;case a.ue:i={x:e.add(r.B(e).B(n.F(Math.tan(this.value.W()%360*Math.PI/180)))),y:n};break;case a.fe:i={x:r,y:t.add(n.B(t).B(r.F(Math.tan(s.W()%360*Math.PI/180))))};break;case a.pe:i={x:r,y:n}}return i}static we(e,t,r,n,a){return a.reduceRight(((r,n)=>n.me(e,t,r.x,r.y)),{x:r,y:n})}static#l(e,t,r,n,a){r.fixed&&(e.x=t?r.value.B(a.x):r.value),n.fixed&&(e.y=t?n.value.B(a.y):n.value)}static de(e,r,n,i){let s,o,c,l,h,u,f,p;if(c=r[0].toLowerCase(),l=r[0].toLowerCase()===r[0],s={x:l?t.ZERO:n.x,y:l?t.ZERO:n.y},n.pending)throw new SyntaxError(`Too few arguments for command ${r[0]}`);if(n.te)throw new SyntaxError(`Dangling fix operator after command ${r[0]}`);switch(c){case"a":o={x:r[6].value,y:r[7].value},i.length&&(o=a.we(s.x,s.y,o.x,o.y,i)),a.#l(o,l,r[6],r[7],n),r=[r[0],r[1].value,r[2].value,r[3].fixed?r[3].value:i.reduceRight(((e,t)=>t.type===a.he?e.add(t.value):e),r[3].value),r[4].value,r[5].value,o.x,o.y];break;case"c":h={x:r[1].value,y:r[2].value},u={x:r[3].value,y:r[4].value},o={x:r[5].value,y:r[6].value},i.length&&(h=a.we(s.x,s.y,h.x,h.y,i),u=a.we(s.x,s.y,u.x,u.y,i),o=a.we(s.x,s.y,o.x,o.y,i)),a.#l(o,l,r[5],r[6],n),r=[r[0],r[1].fixed?l?r[1].value.B(n.x):r[1].value:h.x,r[2].fixed?l?r[2].value.B(n.y):r[2].value:h.y,r[3].fixed?l?r[3].value.B(n.x):r[3].value:u.x,r[4].fixed?l?r[4].value.B(n.y):r[4].value:u.y,o.x,o.y];break;case"s":case"q":h={x:r[1].value,y:r[2].value},o={x:r[3].value,y:r[4].value},i.length&&(h=a.we(s.x,s.y,h.x,h.y,i),o=a.we(s.x,s.y,o.x,o.y,i)),a.#l(o,l,r[3],r[4],n),r=[r[0],h.x,h.y,o.x,o.y];break;case"l":case"h":case"v":let t="v"===c?{value:s.x,fixed:r[1].fixed}:r[1],m="h"===c?{value:s.y,fixed:r[1].fixed}:"v"===c?r[1]:r[2];o={x:t.value,y:m.value},i.length&&(o=a.we(s.x,s.y,o.x,o.y,i)),p=180*Math.atan2(o.y.B(s.y).W(),o.x.B(s.x).W())/Math.PI,a.#l(o,l,t,m,n),(r=o.x.equals(s.x)?o.y.equals(s.y)?null:["v",o.y]:o.y.equals(s.y)?["h",o.x]:["l",o.x,o.y])&&(e.xe.path.Ee&&n.J.length>0&&(f=n.J[n.J.length-1],f[0].toLowerCase()===r[0].toLowerCase()&&p===n.re&&(l?(f.length>2&&(f[2]=f[2].add(r[2])),f[1]=f[1].add(r[1]),r=null):n.ge.pop())),n.re=p);break;case"m":case"t":o={x:r[1].value,y:r[2].value},i.length&&(o=a.we(s.x,s.y,o.x,o.y,i)),a.#l(o,l,r[1],r[2],n),r=[r[0],o.x,o.y],e.xe.path.Ee&&"m"===c&&n.J.length>0&&(f=n.J[n.J.length-1],"m"===f[0].toLowerCase()&&(l?(f[1]=f[1].add(r[1]),f[2]=f[2].add(r[2]),r=null):n.ge.pop()));break;case"z":r=["z"],n.x=n.ne,n.y=n.ae,n.re=null}if("z"!==c&&(n.x=l?n.x.add(o.x):o.x,n.y=l?n.y.add(o.y):o.y),"m"===c&&(n.ne=n.x,n.ae=n.y),r){l||(r[0]=r[0].toUpperCase());const e=i.filter((e=>e.type===a.pe));e.length%2?n.J.splice(e[0].value.W(),0,r):n.J.push(r)}}}class i{constructor(e){this.stream=e}static ye(e,r=t.L){return e.J.map((e=>e[0].toString()+(e.length>1?" "+e.slice(1).join(","):""))).join(" ")}static be(e,t){let r=new i(new n(t)).Re(e);return i.ye(r,e.xe.path.precision)}Re(t,n=r.Z(),a=-1){let i;for(i={Te:this.stream.oe(),$e:!0,index:0};i.$e&&i.Te&&(i.index<a||-1===a);){switch(i.Te.type){case e.p:case e.u:break;case e.$:i.$e=!1;break;default:let a=new s(this.stream).parse(t,0,[],!1,{x:n.x,y:n.y},r.G);n.J.push([a.accumulator]),n.index++,i.Te=this.stream.oe();continue}i.Te=this.stream.ce()}return n}parse(n,i=r.Z(),o=[],c=1,l){let h,u,f,p;for(h={Te:this.stream.oe(),$e:!0},o.forEach((e=>{e.type===a.pe&&(e.value=new t(i.J.length))}));h.$e&&h.Te;){switch(h.Te.type){case e.o:if(null===i.ee&&"m"!==h.Te.name.toLowerCase())throw new SyntaxError("Paths must begin with a Move To command");u&&a.de(n,u,i,o),i.ee=h.Te.value,i.pending=i.ee.length,u=[h.Te.name];break;case e.U:i.te=!0;break;case e.p:case e.u:break;case e.$:u&&a.de(n,u,i,o),h.$e=!1;break;case e.R:case e.i:if(h.Te.type===e.i?(p=this.stream.le(),f=p.type===e.R&&n.ke[p.name]):f=n.ke[h.Te.name],![!1,null,void 0].includes(f)){u&&(a.de(n,u,i,o),u=null),new s(this.stream).Oe(n,i,l,o.concat()),h.Te=this.stream.oe();continue}default:if(!u)throw new Error(`Expected command, but found "${h.Te.name}"`);if(i.pending||(a.de(n,u,i,o),i.pending=i.ee.length,u=[u[0]]),!i.pending)throw new SyntaxError(`Too many parameters supplied to command "${u[0]}"`);if("a"===u[0].toLowerCase()&&(4===i.pending||3===i.pending)&&h.Te.type===e.i&&h.Te.name.length>1&&-1!==["0","1"].indexOf(h.Te.name.substr(0,1)))u.push({fixed:i.te,value:new t(h.Te.name.substr(0,1))}),h.Te.name=h.Te.name.substr(1),h.Te.value=new t(h.Te.name);else if(h.Te.type===e.i?(p=this.stream.le(),f=p.type===e.R?n.ke[p.name]:null):f=n.ke[h.Te.name],null==f){let e=new s(this.stream).parse(n,0,l,!1,{x:i.x,y:i.y},i.ee[i.ee.length-i.pending]);u.push({fixed:i.te,value:e.accumulator})}i.te=!1,i.pending--,h.Te=this.stream.oe();continue}h.Te=this.stream.ce()}return i}}class s{static#h=1;static#u=2;static#f=3;static#p=4;static#m=5;constructor(e){this.stream=e,this.debug=!1}static#w(e){return e.value.toString()+" "+["","=","+","-","*","/"][e.operation]}#d(e,t){var r,n,a;for(r=e.stack.length-1;r>-1&&e.stack[r].operation>t;)r--;if((n=r+1)<e.stack.length){for(e.stack.push({operation:s.#h,value:e.accumulator}),this.debug&&console.log("<<\n"+e.stack.slice(n).map(((e,t)=>t+": "+s.#w(e))).join("\n")),a=e.stack[n].value;n<e.stack.length-1;n++)switch(e.stack[n].operation){case s.#p:a=a.F(e.stack[n+1].value);break;case s.#m:a=a.V(e.stack[n+1].value);break;case s.#u:a=a.add(e.stack[n+1].value);break;case s.#f:a=a.B(e.stack[n+1].value)}e.accumulator=a,e.stack=e.stack.slice(0,r+1)}}parse(n,a=0,i={},o=!1,c,l,h=[]){var u,f;for(u={accumulator:t.ZERO,ve:0,Ie:a,data:0,stack:[]},f={Te:this.stream.oe(),$e:!0};f.$e&&f.Te;){switch(f.Te.type){case e.i:if(u.data===e.p)throw new SyntaxError(`Unexpected space-delimited value "${f.Te.name}" at column ${f.Te.position}`);if(u.data===e.i){if(u.Ie)throw new SyntaxError(`Unexpected token "${f.Te.name}" at column ${f.Te.position}`);f.$e=!1;continue}this.debug&&console.log("Number",f.Te),u.accumulator=f.Te.value,u.data=e.i;break;case e.P:if(u.data!==e.i&&u.data!==e.p)throw new SyntaxError(`Unexpected token "${f.Te.name}" at column ${f.Te.position}`);this.debug&&console.log("/",f.Te),u.stack.push({operation:s.#m,value:u.accumulator}),u.data=e.P;break;case e.I:if(u.data!==e.i&&u.data!==e.p)throw new SyntaxError(`Unexpected token "${f.Te.name}" at column ${f.Te.position}`);this.debug&&console.log("*",f.Te),u.stack.push({operation:s.#p,value:u.accumulator}),u.data=e.I;break;case e.O:if(u.data===e.i&&0===u.Ie){f.$e=!1;continue}if(u.data!==e.i&&0!==u.data&&u.data!==e.T&&u.data!==e.p)throw new SyntaxError(`Unexpected token "${f.Te.name}" at column ${f.Te.position}`);this.debug&&console.log("-",f.Te),this.#d(u,s.#f),u.stack.push({operation:s.#f,value:u.accumulator}),u.data=e.O;break;case e.k:if(u.data!==e.i&&u.data!==e.p)throw new SyntaxError(`Unexpected token "${f.Te.name}" at column ${f.Te.position}`);this.debug&&console.log("+",f.Te),this.#d(u,s.#f),u.stack.push({operation:s.#u,value:u.accumulator}),u.data=e.k;break;case e.D:if(u.data===e.p)throw new SyntaxError(`Unexpected space before measure operator ("${f.Te.name}") at column ${f.Te.position}`);if(u.data===e.i&&(this.debug&&console.log("*",f.Te),u.stack.push({operation:s.#p,value:u.accumulator})),l===r.G)throw new SyntaxError("The unit type is incompatible with the return value of a segment measurement");if(l===r.K)throw new SyntaxError("The flag type is incompatible with the return value of a segment measurement");if(this.stream.ce(),this.stream.oe().type===e.p&&this.stream.ce(),this.stream.oe().type!==e.R)throw new SyntaxError(`Expected identifier at ${this.stream.oe().position}, found "${this.stream.oe().name}"`);let a=r.Z();switch(a.x=c.x,a.y=c.y,a.ee=[],new s(this.stream).Oe(n,a,i,[]),u.data=e.i,l){case r.X:u.accumulator=a.x.B(c.x);break;case r.H:u.accumulator=a.y.B(c.y);break;case r.j:u.accumulator=new t(Math.atan2(a.x.B(c.x).W(),a.y.B(c.y).W())).F(180).V(t.PI)}if(this.stream.oe().type===e.p&&this.stream.ce(),f.Te=this.stream.oe(),f.Te.type!==e.D)throw new SyntaxError(`Expected measurement operator, found "${f.Te.name}`);break;case e.T:if(this.debug&&console.log(f.Te.value?"(":")",f.Te,u.Ie,n.Pe),f.Te.value){if(u.data===e.p)throw new SyntaxError(`Unexpected token "${f.Te.name}" at column ${f.Te.position}`);u.Ie++,u.data===e.i&&(this.debug&&console.log("*",f.Te),u.stack.push({operation:s.#p,value:u.accumulator})),u.accumulator=t.ZERO,u.stack.push({operation:s.#h}),u.data=e.T}else{if(!o&&u.Ie===n.Pe)throw new SyntaxError(`Mismatched bracket at column ${f.Te.position}`);if(u.data!==e.i)throw new SyntaxError(`Unexpected bracket at column ${f.Te.position}`);if(this.#d(u,s.#f),this.#d(u,s.#h),u.stack.pop(),u.data=e.i,o){f.$e=!1;continue}u.Ie--}break;case e.R:if(u.data===e.p)throw new SyntaxError(`Unexpected space-delimited value "${f.Te.name}" at column ${f.Te.position}`);if(!(f.Te.name in i)&&!(f.Te.name in n.unit))throw new ReferenceError(`Reference to undefined unit "${f.Te.name}" at column ${f.Te.position}.`);u.data===e.i&&(this.debug&&console.log("*",f.Te),u.stack.push({operation:s.#p,value:u.accumulator})),this.debug&&console.log("Unit",f.Te),u.accumulator=i[f.Te.name]??n.unit[f.Te.name],u.data=e.i;break;case e.u:if(u.Ie)throw new SyntaxError(`Unexpected delimiter "${f.Te.name}" in expression at column ${f.Te.position}.`);case e.p:if(u.Ie||0===u.data){u.data===e.i&&(u.data=e.p);break}case e.$:if(u.Ie>n.Pe)throw new SyntaxError(`Missing closing bracket(s) at end of segment (nesting depth = ${u.Ie-n.Pe})`);f.$e=!1;continue;default:if(h.includes(f.Te.type)){f.$e=!1;continue}throw new SyntaxError(`Unexpected token "${f.Te.name}" at column ${f.Te.position}`)}f.Te=this.stream.ce()}return this.#d(u,s.#f),this.#d(u,0),u}Oe(t,o,c,l){let h,u,f,p,m,w,d;if(h={Te:this.stream.oe(),$e:!0,_e:!1,Ae:!1,Ne:l,count:!1,Se:{},Ue:!1},h.Te.type===e.i?(h.count=h.Te.value.W(),h._e=!0,h.Te=this.stream.ce()):h.count=1,p=h.Te.name,-1!==o.stack.indexOf(p))throw new ReferenceError(`Segment ${h.Te.name} cannot call itself`);if(!(p in t.ke))throw new ReferenceError(`Reference to undefined section "${p}" at ${h.Te.position}`);for(u=t.ke[p],h.Te=this.stream.ce();!0===h.$e&&h.Te;){switch(h.Te.type){case e._:case e.A:case e.N:this.stream.ce(),w=new s(this.stream).parse(t,0,c,!1,{x:o.x,y:o.y},r.j,[e._,e.A,e.N]),h.Ne.push(new a({[e._]:a.he,[e.A]:a.ue,[e.N]:a.fe}[h.Te.type],w.accumulator)),h.Te=this.stream.oe();continue;case e.S:h.Ne.push(new a(a.pe,null));break;case e.T:if(h.Ae){h.$e=!1;continue}if(!h.Te.value)throw new SyntaxError(`Unexpected token "${h.Te.name}" at column ${h.Te.position}`);for(h.Te=this.stream.ce();!h.Ae;){switch(h.Te.type){case e.T:if(h.Te.value)throw new SyntaxError(`Unexpected token "${h.Te.name}" at column ${h.Te.position}`);h.Ae=!0;continue;case e.R:case e._:case e.C:case e.A:case e.N:switch(h.Ue=!1,p=h.Te.name,d=h.Te.type,d){case e.R:if(t.ke[p])throw new ReferenceError(`Argument "${p}" is already defined as a segment`);break;case e.C:if(h._e)throw new ReferenceError("Execution count is already defined for this invocation")}if(this.stream.le().type===e.p&&(h.Te=this.stream.ce()),h.Te=this.stream.ce(),h.Te.type===e.$)throw new Error(`Unexpected end of segment at ${h.Te.position}`);if(h.Te.type!==e.M)throw new SyntaxError(`Expected assignment operator after argument name, but found "${h.Te.name}"`);switch(h.Te=this.stream.ce(),w=new s(this.stream).parse(t,0,c,!0,{x:o.x,y:o.y},{[e.R]:r.G,[e._]:r.j,[e.A]:r.j,[e.N]:r.j,[e.C]:r.G}[d]),d){case e.R:h.Se[p]=w.accumulator;break;case e._:case e.A:case e.N:h.Ne.push(new a({[e._]:a.he,[e.A]:a.ue,[e.N]:a.fe}[d],w.accumulator));break;case e.C:h.count=w.accumulator.W(),h._e=!0}h.Te=this.stream.oe();continue;case e.u:if(h.Ue)throw new Error(`Unexpected delimiter at column ${h.Te.position}`);h.Ue=!0;case e.p:break;case e.$:throw new Error(`Unexpected end of segment at ${h.Te.position}`);default:throw new SyntaxError(`Unexpected token "${h.Te.name}" at column ${h.Te.position}`)}h.Te=this.stream.ce()}break;case e.p:if([e._,e.A,e.N].includes(this.stream.le().type))break;default:h.$e=!1;continue}h.Te=this.stream.ce()}if(h.count!==parseInt(h.count))throw new Error(`The execution count (${h.count}) for segment "${p}" must be an integer.`);if(h.count<1)throw new Error(`The execution count (${h.count}) for segment "${p}" can't be less than 1.`);for(m=1;m<=h.count;m++)f=new i(new n(u)),f.parse(t,o,h.Ne.concat(),m,h.Se),o.stack.pop();h.$e=!1}}class o{static De(e){return e&&e.constructor?e.constructor.name.toLowerCase():void 0}static Me(e,t=!0){for(t&&"text"===o.De(e.firstChild)&&e.removeChild(e.firstChild);e.firstChild;)e.parentNode.insertBefore(e.firstChild,e);e.parentNode.removeChild(e)}static remove(e,t=!0){t&&"text"===o.De(e.previousSibling)&&e.parentNode.removeChild(e.previousSibling),e.parentNode.removeChild(e)}}class c{static#E;constructor(e){this.document=c.#x(e)}static#x(e){return(new("undefined"==typeof DOMParser?require("xmldom").DOMParser:DOMParser)).parseFromString(e,"text/xml")}static#g(e){let t=Array.from(e.getElementsByTagName("define"));t.forEach((e=>e.parentNode.removeChild(e))),t=t.filter((e=>["t","true","on","yes","y"].includes(e.getAttribute("state").toLowerCase())||0!==(parseFloat(e.getAttribute("state"))||0))).map((e=>e.getAttribute("name"))),Array.from(e.getElementsByTagName("ifdef")).forEach((e=>{t.includes(e.getAttribute("name"))?o.Me(e):o.remove(e)})),Array.from(e.getElementsByTagName("ifndef")).forEach((e=>{t.includes(e.getAttribute("name"))?o.remove(e):o.Me(e)}))}static#y(e,t){let a,i=[];for(;i.length||t.length;){i.length?a=i.pop():(a=t.shift(),a.previousSibling.tagName||""!==a.previousSibling.nodeValue.trim()||a.parentNode.removeChild(a.previousSibling),a.parentNode.removeChild(a));let o=new s(new n(a.getAttribute("value")));try{let t=o.parse(e,1,{},!1,null,r.G),n=a.getAttribute("id");if(n in e.unit)throw new Error(`Duplicate unit ID: "${n}"`);e.unit[n]=t.accumulator}catch(e){if(!(e instanceof ReferenceError))throw new Error("Couldn't parse item, "+e.message,{Ce:e});{if(1===i.filter((e=>e.getAttribute("id")===o.stream.oe().name)).length)throw new ReferenceError(`Circular reference to "${o.stream.oe().name}"`);i.push(a);let e=t.filter((e=>e.getAttribute("id")===o.stream.oe().name));if(e.length>1)throw new ReferenceError(`Unable to resolve expression "${a.getAttribute("value")}". Duplicate ID "${o.stream.oe().name}".`);if(0===e.length)throw new ReferenceError(`Unable to resolve expression "${a.getAttribute("value")}". "${o.stream.oe().name}" is undefined.`);i.push(e[0]),e[0].parentNode.removeChild(e[0]),t=t.slice(0,t.indexOf(e[0])).concat(t.slice(t.indexOf(e[0])+1))}}}}static#b(e,t){let r;for(;t.length;){r=t.shift(),r.previousSibling.tagName||""!==r.previousSibling.nodeValue.trim()||r.parentNode.removeChild(r.previousSibling),r.parentNode.removeChild(r);let n=r.getAttribute("id");if(n in e.unit)throw new Error(`Duplicate literal ID: "${n}"`);e.Ye[n]=r.getAttribute("value")}}static#R(e,t){t.forEach((e=>{e.previousSibling.tagName||""!==e.previousSibling.nodeValue.trim()||e.parentNode.removeChild(e.previousSibling),e.parentNode.removeChild(e)})),e.ke=t.reduce(((t,r)=>{let n=r.getAttribute("id");if(n in t)throw new Error(`Duplicate segment ID: "${n}"`);if(n in e.unit)throw new Error(`Segment ID: "${n}" already defined as a unit`);return t[r.getAttribute("id")]=r.getAttribute("d"),t}),{}),e.Le=Object.keys(e.ke)}#T(e){let t,r=[];do{t=Array.from(this.document.getElementsByTagName("include")),t.forEach((t=>{let n=t.getAttribute("href");if(-1!==r.indexOf(n))throw new Error(`Circular include reference: ${n}`);r.push(n),n=n.split("#");let a=n[0],i=n.length>1?n.slice(1).join("#"):null;const s=require("fs").qe(e.ve+a,{encoding:"utf-8",ze:"r"});let o,l=c.#x(s);if(null!==i){if(o=l.getElementById(i),!o)throw new Error(`Failed to include file: ${a}, ID: ${i}`)}else if(o=l.documentElement,!o)throw new Error(`Failed to include file: ${a}`);if("svg"===o.nodeName.toLowerCase()){let e=o.firstChild;for(;e;){let r=e;e=e.nextSibling,t.parentNode.insertBefore(r,t)}}else{let e=o;for(;e;){let r=e;e=e.nextSibling,t.parentNode.insertBefore(r,t)}}t.parentNode.removeChild(t)}))}while(t.length)}static#$(e,t,r,n,a){if(Object.entries(t).forEach((([e,t])=>r=r.replaceAll(e,t))),!r.length||n.Le.includes(r)){const i=e.cloneNode(!0);if(Array.from(i.getElementsByTagName("*")).forEach((e=>{Array.from(e.attributes).forEach((e=>Object.entries(t).forEach((([t,r])=>e.value=e.value.replaceAll(t,r))))),(r=e.getAttribute("if")).length&&!n.Le.includes(r)&&e.parentNode.removeChild(e),e.removeAttribute("if")})),i.firstChild&&!i.firstChild.tagName&&""===i.firstChild.nodeValue.trim()&&i.removeChild(i.firstChild),a)for(;i.firstChild;)a.appendChild(i.firstChild);else for(;i.firstChild;)e.parentNode.insertBefore(i.firstChild,e)}}static#k(e,t){return t.length&&t==="f".repeat(t.length)?e.toString(16).padStart(t.length,"0"):t==="0".repeat(t.length)?e.toString().padStart(t.length,"0"):e.toString()}static#O(e,t,r){const n=t.getAttribute(r);return e.Ye[n]??n}static#v(e,t){let r=t.getElementsByTagName("template")[0];for(;r;){if("repeat"===r.getAttribute("type")){let t,n,a,s=c.#O(e,r,"range").split(new RegExp("\\s*,\\s*","gm")).filter((e=>""!==e)).map((e=>{let[r,a]=e.trim().split(new RegExp("\\s*-\\s*","gm")).slice(0,2).map((e=>parseInt(e)||0));return r>a&&([r,a]=[a,r]),(void 0===t||r<t)&&(t=r),(void 0===n||a>n)&&(n=a),{lower:r,upper:a}})),o=parseInt(i.be(e,r.getAttribute("step")))||1,l=parseInt(c.#O(e,r,"column-count"))||0,h=parseInt(c.#O(e,r,"g-row-count"))||0,u=c.#O(e,r,"g-row-id"),f=c.#O(e,r,"v-map").split(new RegExp("\\s*,\\s*","gm")).filter((e=>""!==e)).map((e=>{let[r,a]=e.trim().split(new RegExp("\\s*:\\s*","gm"));return r=r.split("-"),r.length<2?r[1]=r[0]:r.length>2&&(r=r.slice(0,2)),r=r.map(((e,r)=>"*"===e||""===e?0===r?t:n:parseInt(e)||0)),{start:r[0],stop:r[1],value:a??""}})),p=r.getAttribute("if")??"",m=r.getAttribute("i-format")??"",w=r.getAttribute("v-format")??"",d=r.getAttribute("x-format")??"",E=r.getAttribute("y-format")??"",x=r.getAttribute("g-format")??"",g=0,y=0,b=-1;s.forEach((t=>{for(let n=t.lower;n<=t.upper;n+=o){let t=f.find((e=>n>=e.start&&n<=e.stop))?.value??n;h&&g%h==0&&0===y&&b++;const i={Be:c.#k(y,d),Fe:c.#k(g,E),Ve:c.#k(n,m),We:c.#k(t,w),Xe:c.#k(b,x),He:c.#k(g-b*h,E)};if(h&&g%h==0&&0===y){a=r.ownerDocument.createElement("g");let e=u;Object.entries(i).forEach((([t,r])=>e=e.replaceAll(t,r))),a.setAttribute("id",e),r.parentNode.insertBefore(a,r)}c.#$(r,i,p,e,a),y++,y===l&&(y=0,g++)}}))}r.parentNode.removeChild(r),r=t.getElementsByTagName("template")[0]}}#I(e,t,r){const n=require("path");return r.filter((e=>e.hasAttribute("id"))).map((r=>{let a=e.cloneNode(!0),i=a.firstChild,s=null,o=[];for(;i;)if(!i.firstChild||o.includes(i.firstChild)){let e=i.nextSibling??i.parentNode;if(i.tagName&&i.hasAttribute("id")){let e=i;for(;e&&"defs"!==e.tagName;)e=e.parentNode;if(e)o.push(i);else if(i.getAttribute("id")!==r.getAttribute("id")||null!==s){let e=i.parentNode;i.previousSibling&&!i.previousSibling.tagName&&""===i.previousSibling.nodeValue.trim()&&e.removeChild(i.previousSibling),e.removeChild(i)}else null===s&&(s=i,s.removeAttribute("id")),o.push(i)}else o.push(i);i=e}else i=i.firstChild;const c=[];if(s){for(;s&&!s.hasAttribute("dir");)c.push(s),s=s.parentNode;if(s)if(1===s.attributes.length&&s.parentNode){const e=s.parentNode;e.insertBefore(c[c.length-1],s),e.removeChild(s)}else s.removeAttribute("dir")}else a=null;return[t+(s?s.getAttribute("dir")+n.je:"")+r.getAttribute("id")+".svg",a]})).filter((([,e])=>null!==e))}transform(e){let t;if(e.Ke&&c.#E)t=c.#E;else{t={Ye:{},unit:{},Pe:1,cache:{path:{}},xe:{path:{precision:e.precision,Ee:e.Ge},Ze:{Je:"xml"===e.Je||"all"===e.Je,Qe:e.Qe}}},this.#T(e),c.#g(this.document),c.#y(t,Array.from(this.document.getElementsByTagName("unit"))),c.#b(t,Array.from(this.document.getElementsByTagName("literal")));for(let r in e.unit)t.unit[r]=e.unit[r];c.#R(t,Array.from(this.document.getElementsByTagName("segment"))),c.#E=t}c.#v(t,this.document);let r=Array.from(this.document.getElementsByTagName("path"));for(t.Pe=0;r.length;){let e,a=r.shift(),s=a.getAttribute("d");if(t.cache.path[s])e=t.cache.path[s];else{let r=new i(new n(s)).parse(t);e=i.ye(r,t.xe.path.precision),t.cache.path[s]=e}a.setAttribute("d",e)}if([{tagName:"svg",et:[{name:"viewBox",tt:4},"width","height"]},{tagName:"rect",et:["x","y","width","height","rx","ry"]},{tagName:"text",et:["x","y"]},{tagName:"use",et:["x","y"]},{tagName:"circle",et:["r","cx","cy"]},{tagName:"ellipse",et:["rx","ry","cx","cy"]},{tagName:"line",et:["x1","y1","x2","y2"]},{tagName:"image",et:["x","y","width","height"]},{tagName:"pattern",et:["width","height"]},{tagName:"polygon",et:[{name:"points",tt:-1}]},{tagName:"polyline",et:[{name:"points",tt:-1}]},{tagName:"line",et:["x1","y1","x2","y2"]},{tagName:"textPath",et:["startOffset"]},{tagName:"path",et:["stroke-width"]},{tagName:"image",et:["x","y","width","height"]},{tagName:"marker",et:["markerWidth","markerHeight","refX","refY"]}].forEach((e=>{for(r=Array.from(this.document.getElementsByTagName(e.tagName)),t.Pe=0;r.length;){let n=r.shift();e.et.forEach((e=>{let r;r="string"==typeof e?e:e.name,n.hasAttribute(r)&&n.setAttribute(r,i.be(t,n.getAttribute(r)))}))}})),t.xe.Ze.Je||t.xe.Ze.Qe){let e=[],r=this.document.documentElement.firstChild,n={COMMENT_NODE:8,TEXT_NODE:3};for(;e.length||r;){r.firstChild&&e.push(r.firstChild);let a=r;r=r.nextSibling?r.nextSibling:e.pop(),t.xe.Ze.Je&&a.nodeType===n.TEXT_NODE&&0===a.nodeValue.replace(new RegExp("\\s+","g"),"").length&&a.parentNode.removeChild(a),t.xe.Ze.Qe&&a.nodeType===n.COMMENT_NODE&&a.parentNode.removeChild(a)}}if(e.rt){const t=require("path");let n=e.destination+t.je;r=this.#I(this.document.documentElement,n,Array.from(this.document.getElementsByTagName("*")))}else r=[[e.destination,this.document.documentElement]];return r.map((([e,t])=>[e,(new("undefined"==typeof XMLSerializer?require("xmldom").XMLSerializer:XMLSerializer)).serializeToString(t)]))}}!function(){const e=require("fs"),t=require("path");let r,n=process.argv[2],a=!1;e.nt(n)&&e.it(n).isDirectory()?(process.chdir(n),n=t.join(n,"comseq.txt"),r=e.qe(n,"utf-8").split("\n").map((e=>e.trim())).map((e=>e.split(new RegExp("\\s+")))),a=!0):r=[process.argv.slice(2)],r.forEach(((n,i)=>{n=n.map((e=>t.join(...e.split(new RegExp("\\\\","g"))))),a&&console.log(`Command ${i+1} of ${r.length}`,'["'+n.join('", "')+'"]');let s=Date.now(),o=!0,l=!0,h=["path","xml","all"],u={Je:null,Qe:!1,Ge:!1,precision:3,Ke:!1};for(;l&&o&&n[0]&&n[0].startsWith("--");)switch(n[0]){case"--precision":u.precision=parseInt(n[1]),u.precision.toString()!==n[1]||isNaN(u.precision)?(console.log("Invalid syntax for --precision switch"),o=!1):n=n.slice(2);break;case"--stripWhitespace":u.Je=n[1],-1===h.indexOf(u.Je)?(console.log("Invalid syntax for --stripWhitespace switch"),o=!1):n=n.slice(2);break;case"--stripComments":u.Qe=!0,n.shift();break;case"--combinePathCommands":u.Ge=!0,n.shift();break;case"--extract":u.rt=!0,n.shift();break;case"--report":u.st=!0,n.shift();break;case"--sharedContext":u.Ke=!0,n.shift();break;case"--":n.shift();default:l=!1}if(!o||n.length<2)console.log('\nUsage: npm start -- [options] <source> <destination> [units...]\n\nsource       An unprocessed SVG file containing Pather commands\ndestination  Desired filename of the processed output\noptions      One or more of the following switches:\n\t--precision <n>                   Write numbers to the output with N decimal places. Default is 3\n\t--stripWhitespace <path|xml|all>  Strip whitespace from within path data, between XML tags or both (all)\n\t--stripComments                   Strip XML comments from the output document\n\t--combinePathCommands             Combine repeated commands in path data, e.g. h 30 h 30 becomes h 60\n\t--extract                         Extract all elements with an ID to individual files (destination is a directory)\n\t--report                          Report information before and after processing a file\nunits        Variable values to be passed to the Pather environment\n             Name/value pairs separated by "=", e.g. myUnit=3 myOtherUnit=4.2\n');else{let r=n.shift();for(u.destination=n.shift(),u.st&&console.log(`Processing "${r}"...`),u.unit={},l=!0;l&&n.length;){let e,t=n.shift().split("=");switch(!0){case 2!==t.length:e=`Invalid unit format "${t.join("=")}".`;break;case null===new RegExp("^[bdefgijknopruwxy]|[a-z_$][a-z0-9_$]+$","i").exec(t[0]):e=`Invalid unit name "${t[0]}".`;break;case parseFloat(t[1]).toString()!==t[1].substr(0,parseFloat(t[1]).toString().length)||isNaN(parseFloat(t[1]))||parseFloat(t[1])===1/0||parseFloat(t[1])===-1/0:e=`Invalid unit value "${t[1]}".`}e?(console.log(`${e} Expected valid identifier followed by a number, e.g. myUnit=3`),l=!1):u.unit[t[0]]=parseFloat(t[1])}if(l){u.ve=t.ot(r)+t.je;const n=e.qe(r,{encoding:"utf-8",ze:"r"});new c(n).transform(u).forEach((([r,n])=>{e.nt(t.ot(r))||e.ct(t.ot(r),{lt:!0}),e.ht(r,n,{encoding:"utf-8"})})),u.st&&console.log(`Completed successfully in ${Date.now()-s} ms\n`)}}}))}()}));
//# sourceMappingURL=pather.min.js.map
