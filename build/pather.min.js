!function(e){"function"==typeof define&&define.amd?define(["fs"],e):e()}((function(){"use strict";class e{static i=1;static o=2;static u=3;static p=4;static R=5;static T=6;static $=7;static k=8;static I=9;static P=10;static O=11;static A=12;static N=13;static _=14;static S=15;static U=16;static M=17;static D=18;constructor(e,t,r,n){this.type=e,this.name=t,this.value=r,this.position=n}static Y(t){return Object.entries(e).filter((([e,r])=>r===t))[0][0]}}class t{static L=18;static PI=new t("3.141592653589793238");static#e=BigInt("1"+"0".repeat(t.L));static#t=new RegExp("\\.?0+$");#r;constructor(e=0){let r,n;e instanceof t?this.#r=e.#r:e instanceof BigInt?this.#r=value*t.C:([r,n]=(e+".").split("."),this.#r=BigInt(r+n.substr(0,t.L).padEnd(t.L,"0")),n.charCodeAt(t.L)>52&&this.#r++)}#n(e){let r;return r=new t(this),r.#r=e,r}#i(e,t){return this.#n(e/t+2n*e/t%2n)}add(e){return this.#n(this.#r+new t(e).#r)}B(e){return this.#n(this.#r-new t(e).#r)}F(e){return this.#i(this.#r*new t(e).#r,t.#e)}W(e){return this.#i(this.#r*t.#e,new t(e).#r)}equals(e){return this.valueOf()==e}valueOf(){return this.#r}V(){return+this.toString()}toString(e=t.L){let r;return r=this.#i(this.#r,BigInt("1"+"0".repeat(e>-1?Math.max(t.L-e,0):t.L))).#r.toString().padStart(e+1,"0"),r.substr(0,r.length-e)+("."+r.substr(-e)).replace(t.#t,"")}}class r{static X=1;static H=2;static G=3;static K=4;static j=5;static Z(){return{stack:[],J:[],ee:null,pending:0,x:new t(0),y:new t(0),te:!1,re:null,ne:new t(0),ie:new t(0)}}}class n{static#a=[{type:e.i,ae:new RegExp("^[0-9]*\\.?[0-9]+",""),se:e=>new t(e)},{type:e.o,ae:new RegExp("^[achlmqstvz](?![a-z_$])","i"),se:e=>({a:[r.X,r.H,r.G,r.K,r.K,r.X,r.H],c:[r.X,r.H,r.X,r.H,r.X,r.H],h:[r.X],l:[r.X,r.H],m:[r.X,r.H],q:[r.X,r.H,r.X,r.H],s:[r.X,r.H,r.X,r.H],t:[r.X,r.H],v:[r.H],z:[]}[e.toLowerCase()])},{type:e.u,ae:new RegExp("^,+",""),se:()=>null},{type:e.p,ae:new RegExp("^\\s+",""),se:()=>null},{type:e.R,ae:new RegExp("^[a-z_$][a-z0-9_$]*","i"),se:e=>e},{type:e.T,ae:new RegExp("^[()]",""),se:e=>"("===e},{type:e.k,ae:new RegExp("^\\+",""),se:e=>e},{type:e.P,ae:new RegExp("^\\*",""),se:e=>e},{type:e.I,ae:new RegExp("^-",""),se:e=>e},{type:e.O,ae:new RegExp("^/",""),se:e=>e},{type:e.A,ae:new RegExp("^%r",""),se:e=>e},{type:e.N,ae:new RegExp("^%h",""),se:e=>e},{type:e._,ae:new RegExp("^%v",""),se:e=>e},{type:e.S,ae:new RegExp("^@",""),se:e=>e},{type:e.U,ae:new RegExp("^\\|",""),se:e=>e},{type:e.M,ae:new RegExp("^=",""),se:e=>e},{type:e.D,ae:new RegExp("^#",""),se:e=>e}];#s=null;#o=0;constructor(t){var r,i,a,s;for(this.#s=[],i=0;t.length;){for(r=0;r<n.#a.length;r++)if(a=(s=n.#a[r]).ae.exec(t)){this.#s.push(new e(s.type,a[0],s.se(a[0]),i)),i+=a[0].length,t=t.substr(a[0].length);break}if(r===n.#a.length)throw new SyntaxError(`Unexpected symbol "${t.substr(0,1)}" at column ${i}`)}this.#s.push(new e(e.$,null,null,i))}oe(){return this.#s[this.#o]??null}ce(){return this.#o++,this.oe()}le(){return this.#s[this.#o+1]??null}reset(){return this.#o=0,this.oe()}}class i{static he=1;static ue=2;static pe=3;constructor(e,t){this.type=e,this.value=t}#c(){return{[i.he]:"Rotate",[i.ue]:"Vertical skew",[i.pe]:"Horizontal skew"}[this.type]??"Unknown"}toString(){return`${this.#c()}: ${this.value}`}fe(e,t,r,n){let a,s;switch(this.type){case i.he:let o,c;r=r.B(e),n=n.B(t),s=this.value.V()%360*Math.PI/180,o=Math.cos(s),c=Math.sin(s),Math.abs(o-c)<2*Number.EPSILON?c=o:Math.abs(o+c)<2*Number.EPSILON&&(o=c),Math.abs(o)<Number.EPSILON&&(o=0),Math.abs(c)<Number.EPSILON&&(c=0),a={x:e.add(r.F(o)).B(n.F(c)),y:t.add(n.F(o)).add(r.F(c))};break;case i.ue:a={x:e.add(r.B(e).B(n.F(Math.tan(this.value.V()%360*Math.PI/180)))),y:n};break;case i.pe:a={x:r,y:t.add(n.B(t).B(r.F(Math.tan(s.V()%360*Math.PI/180))))}}return a}static we(e,t,r,n,i){return i.reduceRight(((r,n)=>n.fe(e,t,r.x,r.y)),{x:r,y:n})}static#l(e,t,r,n,i){r.fixed&&(e.x=t?r.value.B(i.x):r.value),n.fixed&&(e.y=t?n.value.B(i.y):n.value)}static me(e,r,n,a){let s,o,c,l,h,u,p,f;if(c=r[0].toLowerCase(),l=r[0].toLowerCase()===r[0],s={x:l?new t(0):n.x,y:l?new t(0):n.y},n.pending)throw new SyntaxError(`Too few arguments for command ${r[0]}`);if(n.te)throw new SyntaxError(`Dangling fix operator after command ${r[0]}`);switch(c){case"a":o={x:r[6].value,y:r[7].value},a.length&&(o=i.we(s.x,s.y,o.x,o.y,a)),i.#l(o,l,r[6],r[7],n),r=[r[0],r[1].value,r[2].value,r[3].fixed?r[3].value:a.reduceRight(((e,t)=>t.type===i.he?e.add(t.value):e),r[3].value),r[4].value,r[5].value,o.x,o.y];break;case"c":h={x:r[1].value,y:r[2].value},u={x:r[3].value,y:r[4].value},o={x:r[5].value,y:r[6].value},a.length&&(h=i.we(s.x,s.y,h.x,h.y,a),u=i.we(s.x,s.y,u.x,u.y,a),o=i.we(s.x,s.y,o.x,o.y,a)),i.#l(o,l,r[5],r[6],n),r=[r[0],r[1].fixed?l?r[1].value.B(n.x):r[1].value:h.x,r[2].fixed?l?r[2].value.B(n.y):r[2].value:h.y,r[3].fixed?l?r[3].value.B(n.x):r[3].value:u.x,r[4].fixed?l?r[4].value.B(n.y):r[4].value:u.y,o.x,o.y];break;case"s":case"q":h={x:r[1].value,y:r[2].value},o={x:r[3].value,y:r[4].value},a.length&&(h=i.we(s.x,s.y,h.x,h.y,a),o=i.we(s.x,s.y,o.x,o.y,a)),i.#l(o,l,r[3],r[4],n),r=[r[0],h.x,h.y,o.x,o.y];break;case"l":case"h":case"v":let w="v"===c?{value:new t(s.x),fixed:r[1].fixed}:r[1],m="h"===c?{value:new t(s.y),fixed:r[1].fixed}:"v"===c?r[1]:r[2];o={x:w.value,y:m.value},a.length&&(o=i.we(s.x,s.y,o.x,o.y,a)),f=180*Math.atan2(o.y.B(s.y).V(),o.x.B(s.x).V())/Math.PI,i.#l(o,l,w,m,n),(r=o.x.equals(s.x)?o.y.equals(s.y)?null:["v",o.y]:o.y.equals(s.y)?["h",o.x]:["l",o.x,o.y])&&(e.xe.path.de&&n.J.length>0&&(p=n.J[n.J.length-1],p[0].toLowerCase()===r[0].toLowerCase()&&f===n.re&&(l?(p.length>2&&(p[2]=p[2].add(r[2])),p[1]=p[1].add(r[1]),r=null):n.Ee.pop())),n.re=f);break;case"m":case"t":o={x:r[1].value,y:r[2].value},a.length&&(o=i.we(s.x,s.y,o.x,o.y,a)),i.#l(o,l,r[1],r[2],n),r=[r[0],o.x,o.y],e.xe.path.de&&"m"===c&&n.J.length>0&&(p=n.J[n.J.length-1],"m"===p[0].toLowerCase()&&(l?(p[1]=p[1].add(r[1]),p[2]=p[2].add(r[2]),r=null):n.Ee.pop()));break;case"z":r=["z"],n.x=new t(n.ne),n.y=new t(n.ie),n.re=null}"z"!==c&&(n.x=l?n.x.add(o.x):o.x,n.y=l?n.y.add(o.y):o.y),"m"===c&&(n.ne=new t(n.x),n.ie=new t(n.y)),r&&(l||(r[0]=r[0].toUpperCase()),n.J.push(r))}}class a{constructor(e){this.stream=e}static ge(e,r=t.L){return e.J.map((e=>e[0].toString()+(e.length>1?" "+e.slice(1).join(","):""))).join(" ")}static ye(e,t){let r=new a(new n(t)).be(e);return a.ge(r,e.xe.path.precision)}be(t,n=r.Z(),i=-1){let a;for(a={Re:this.stream.oe(),Te:!0,index:0};a.Te&&a.Re&&(a.index<i||-1===i);){switch(a.Re.type){case e.p:case e.u:break;case e.$:a.Te=!1;break;default:let i=new s(this.stream).parse(t,0,[],!1,{x:n.x,y:n.y},r.j);n.J.push([i.accumulator]),n.index++,a.Re=this.stream.oe();continue}a.Re=this.stream.ce()}return n}parse(n,a=r.Z(),o=[],c=1,l){let h,u,p,f;for(h={Re:this.stream.oe(),Te:!0};h.Te&&h.Re;){switch(h.Re.type){case e.o:if(null===a.ee&&"m"!==h.Re.name.toLowerCase())throw new SyntaxError("Paths must begin with a Move To command");u&&i.me(n,u,a,o),a.ee=h.Re.value,a.pending=a.ee.length,u=[h.Re.name];break;case e.S:a.te=!0;break;case e.p:case e.u:break;case e.$:u&&i.me(n,u,a,o),h.Te=!1;break;case e.R:case e.i:if(h.Re.type===e.i?(f=this.stream.le(),p=f.type===e.R&&n.$e[f.name]):p=n.$e[h.Re.name],p){u&&(i.me(n,u,a,o),u=null),new s(this.stream).ke(n,a,l,o.concat()),h.Re=this.stream.oe();continue}default:if(!u)throw new Error(`Expected command, but found "${h.Re.name}"`);if(a.pending||(i.me(n,u,a,o),a.pending=a.ee.length,u=[u[0]]),!a.pending)throw new SyntaxError(`Too many parameters supplied to command "${u[0]}"`);if("a"===u[0].toLowerCase()&&(4===a.pending||3===a.pending)&&h.Re.type===e.i&&h.Re.name.length>1&&-1!==["0","1"].indexOf(h.Re.name.substr(0,1)))u.push({fixed:a.te,value:new t(h.Re.name.substr(0,1))}),h.Re.name=h.Re.name.substr(1),h.Re.value=new t(h.Re.name);else if(h.Re.type===e.i?(f=this.stream.le(),p=f.type===e.R&&n.$e[f.name]):p=n.$e[h.Re.name],!p){let e=new s(this.stream).parse(n,0,l,!1,{x:a.x,y:a.y},a.ee[a.ee.length-a.pending]);u.push({fixed:a.te,value:e.accumulator})}a.te=!1,a.pending--,h.Re=this.stream.oe();continue}h.Re=this.stream.ce()}return a}}class s{static#h=1;static#u=2;static#p=3;static#f=4;static#w=5;constructor(e){this.stream=e,this.debug=!1}static#m(e){return e.value.toString()+" "+["","=","+","-","*","/"][e.operation]}#d(e,t){var r,n,i;for(r=e.stack.length-1;r>-1&&e.stack[r].operation>t;)r--;if((n=r+1)<e.stack.length){for(e.stack.push({operation:s.#h,value:e.accumulator}),this.debug&&console.log("<<\n"+e.stack.slice(n).map(((e,t)=>t+": "+s.#m(e))).join("\n")),i=e.stack[n].value;n<e.stack.length-1;n++)switch(e.stack[n].operation){case s.#f:i=i.F(e.stack[n+1].value);break;case s.#w:i=i.W(e.stack[n+1].value);break;case s.#u:i=i.add(e.stack[n+1].value);break;case s.#p:i=i.B(e.stack[n+1].value)}e.accumulator=i,e.stack=e.stack.slice(0,r+1)}}parse(n,i=0,a={},o=!1,c,l,h=[]){var u,p;for(u={accumulator:new t(0),Ie:0,Pe:i,data:0,stack:[]},p={Re:this.stream.oe(),Te:!0};p.Te&&p.Re;){switch(p.Re.type){case e.i:if(u.data===e.p)throw new SyntaxError(`Unexpected space-delimited value "${p.Re.name}" at column ${p.Re.position}`);if(u.data===e.i){if(u.Pe)throw new SyntaxError(`Unexpected token "${p.Re.name}" at column ${p.Re.position}`);p.Te=!1;continue}this.debug&&console.log("Number",p.Re),u.accumulator=p.Re.value,u.data=e.i;break;case e.O:if(u.data!==e.i&&u.data!==e.p)throw new SyntaxError(`Unexpected token "${p.Re.name}" at column ${p.Re.position}`);this.debug&&console.log("/",p.Re),u.stack.push({operation:s.#w,value:u.accumulator}),u.data=e.O;break;case e.P:if(u.data!==e.i&&u.data!==e.p)throw new SyntaxError(`Unexpected token "${p.Re.name}" at column ${p.Re.position}`);this.debug&&console.log("*",p.Re),u.stack.push({operation:s.#f,value:u.accumulator}),u.data=e.P;break;case e.I:if(u.data===e.i&&0===u.Pe){p.Te=!1;continue}if(u.data!==e.i&&0!==u.data&&u.data!==e.T&&u.data!==e.p)throw new SyntaxError(`Unexpected token "${p.Re.name}" at column ${p.Re.position}`);this.debug&&console.log("-",p.Re),this.#d(u,s.#p),u.stack.push({operation:s.#p,value:u.accumulator}),u.data=e.I;break;case e.k:if(u.data!==e.i&&u.data!==e.p)throw new SyntaxError(`Unexpected token "${p.Re.name}" at column ${p.Re.position}`);this.debug&&console.log("+",p.Re),this.#d(u,s.#p),u.stack.push({operation:s.#u,value:u.accumulator}),u.data=e.k;break;case e.U:if(u.data===e.p)throw new SyntaxError(`Unexpected space before measure operator ("${p.Re.name}") at column ${p.Re.position}`);if(u.data===e.i&&(this.debug&&console.log("*",p.Re),u.stack.push({operation:s.#f,value:u.accumulator})),l===r.j)throw new SyntaxError("The unit type is incompatible with the return value of a segment measurement");if(l===r.K)throw new SyntaxError("The flag type is incompatible with the return value of a segment measurement");if(this.stream.ce(),this.stream.oe().type===e.p&&this.stream.ce(),this.stream.oe().type!==e.R)throw new SyntaxError(`Expected identifier at ${this.stream.oe().position}, found "${this.stream.oe().name}"`);let i=r.Z();switch(i.x=c.x,i.y=c.y,i.ee=[],new s(this.stream).ke(n,i,a,[]),u.data=e.i,l){case r.X:u.accumulator=i.x.B(c.x),console.log("RETURNING X",u.accumulator.toString());break;case r.H:u.accumulator=i.y.B(c.y),console.log("RETURNING Y",u.accumulator.toString());break;case r.G:u.accumulator=new t(Math.atan2(i.x.B(c.x).V(),i.y.B(c.y).V())).F(180).W(t.PI),console.log("RETURNING THETA",u.accumulator.toString())}if(this.stream.oe().type===e.p&&this.stream.ce(),p.Re=this.stream.oe(),p.Re.type!==e.U)throw new SyntaxError(`Expected measurement operator, found "${p.Re.name}`);break;case e.T:if(this.debug&&console.log(p.Re.value?"(":")",p.Re,u.Pe,n.ve),p.Re.value){if(u.data===e.p)throw new SyntaxError(`Unexpected token "${p.Re.name}" at column ${p.Re.position}`);u.Pe++,u.data===e.i&&(this.debug&&console.log("*",p.Re),u.stack.push({operation:s.#f,value:u.accumulator})),u.accumulator=new t(0),u.stack.push({operation:s.#h}),u.data=e.T}else{if(!o&&u.Pe===n.ve)throw new SyntaxError(`Mismatched bracket at column ${p.Re.position}`);if(u.data!==e.i)throw new SyntaxError(`Unexpected bracket at column ${p.Re.position}`);if(this.#d(u,s.#p),this.#d(u,s.#h),u.stack.pop(),u.data=e.i,o){p.Te=!1;continue}u.Pe--}break;case e.R:if(u.data===e.p)throw new SyntaxError(`Unexpected space-delimited value "${p.Re.name}" at column ${p.Re.position}`);if(!(p.Re.name in a)&&!(p.Re.name in n.unit))throw new ReferenceError(`Reference to undefined unit "${p.Re.name}" at column ${p.Re.position}.`);u.data===e.i&&(this.debug&&console.log("*",p.Re),u.stack.push({operation:s.#f,value:u.accumulator})),this.debug&&console.log("Unit",p.Re),u.accumulator=a[p.Re.name]??n.unit[p.Re.name],u.data=e.i;break;case e.u:if(u.Pe)throw new SyntaxError(`Unexpected delimiter "${p.Re.name}" in expression at column ${p.Re.position}.`);case e.p:if(u.Pe||0===u.data){u.data===e.i&&(u.data=e.p);break}case e.$:if(u.Pe>n.ve)throw new SyntaxError(`Missing closing bracket(s) at end of segment (nesting depth = ${u.Pe-n.ve})`);p.Te=!1;continue;default:if(h.includes(p.Re.type)){p.Te=!1;continue}throw new SyntaxError(`Unexpected token "${p.Re.name}" at column ${p.Re.position}`)}p.Re=this.stream.ce()}return this.#d(u,s.#p),this.#d(u,0),u}ke(t,o,c,l){let h,u,p,f,w,m,d;if(h={Re:this.stream.oe(),Te:!0,Oe:!1,Ae:!1,Ne:l,count:!1,_e:{},Se:!1},h.Re.type===e.i?(h.count=h.Re.value.V(),h.Oe=!0,h.Re=this.stream.ce()):h.count=1,f=h.Re.name,-1!==o.stack.indexOf(f))throw new ReferenceError(`Segment ${h.Re.name} cannot call itself`);if(!(f in t.$e))throw new ReferenceError(`Reference to undefined section "${f}" at ${h.Re.position}`);for(u=t.$e[f],h.Re=this.stream.ce();!0===h.Te&&h.Re;){switch(h.Re.type){case e.A:case e.N:case e._:this.stream.ce(),m=new s(this.stream).parse(t,0,c,!1,{x:o.x,y:o.y},r.G,[e.A,e.N,e._]),h.Ne.push(new i({[e.A]:i.he,[e.N]:i.ue,[e._]:i.pe}[h.Re.type],m.accumulator)),h.Re=this.stream.oe();continue;case e.T:if(h.Ae){h.Te=!1;continue}if(!h.Re.value)throw new SyntaxError(`Unexpected token "${h.Re.name}" at column ${h.Re.position}`);for(h.Re=this.stream.ce();!h.Ae;){switch(h.Re.type){case e.T:if(h.Re.value)throw new SyntaxError(`Unexpected token "${h.Re.name}" at column ${h.Re.position}`);h.Ae=!0;continue;case e.R:case e.A:case e.D:case e.N:case e._:switch(h.Se=!1,f=h.Re.name,d=h.Re.type,d){case e.R:if(t.$e[f])throw new ReferenceError(`Argument "${f}" is already defined as a segment`);break;case e.D:if(h.Oe)throw new ReferenceError("Execution count is already defined for this invocation")}if(this.stream.le().type===e.p&&(h.Re=this.stream.ce()),h.Re=this.stream.ce(),h.Re.type===e.$)throw new Error(`Unexpected end of segment at ${h.Re.position}`);if(h.Re.type!==e.M)throw new SyntaxError(`Expected assignment operator after argument name, but found "${h.Re.name}"`);switch(h.Re=this.stream.ce(),m=new s(this.stream).parse(t,0,c,!0,{x:o.x,y:o.y},{[e.R]:r.j,[e.A]:r.G,[e.N]:r.G,[e._]:r.G,[e.D]:r.j}[d]),d){case e.R:h._e[f]=m.accumulator;break;case e.A:case e.N:case e._:h.Ne.push(new i({[e.A]:i.he,[e.N]:i.ue,[e._]:i.pe}[d],m.accumulator));break;case e.D:h.count=m.accumulator.V(),h.Oe=!0}h.Re=this.stream.oe();continue;case e.u:if(h.Se)throw new Error(`Unexpected delimiter at column ${h.Re.position}`);h.Se=!0;case e.p:break;case e.$:throw new Error(`Unexpected end of segment at ${h.Re.position}`);default:throw new SyntaxError(`Unexpected token "${h.Re.name}" at column ${h.Re.position}`)}h.Re=this.stream.ce()}break;case e.p:if([e.A,e.N,e._].includes(this.stream.le().type))break;default:h.Te=!1;continue}h.Re=this.stream.ce()}if(h.count!==parseInt(h.count))throw new Error(`The execution count (${h.count}) for segment "${f}" must be an integer.`);if(h.count<1)throw new Error(`The execution count (${h.count}) for segment "${f}" can't be less than 1.`);for(w=1;w<=h.count;w++)p=new a(new n(u)),p.parse(t,o,h.Ne.concat(),w,h._e),o.stack.pop();h.Te=!1}}class o{constructor(e){this.document=o.#x(e)}static#x(e){return(new("undefined"==typeof DOMParser?require("xmldom").DOMParser:DOMParser)).parseFromString(e,"text/xml")}static#E(e,t){let i,a=[];for(;a.length||t.length;){a.length?i=a.pop():(i=t.shift(),i.previousSibling.tagName||""!==i.previousSibling.nodeValue.trim()||i.parentNode.removeChild(i.previousSibling),i.parentNode.removeChild(i));let o=new s(new n(i.getAttribute("value")));try{let t=o.parse(e,1,{},!1,null,r.j),n=i.getAttribute("id");if(n in e.unit)throw new Error(`Duplicate unit ID: "${n}"`);e.unit[n]=t.accumulator}catch(e){if(!(e instanceof ReferenceError))throw new Error("Couldn't parse item, "+e.message,{Ue:e});{if(1===a.filter((e=>e.getAttribute("id")===o.stream.oe().name)).length)throw new ReferenceError(`Circular reference to "${o.stream.oe().name}"`);a.push(i);let e=t.filter((e=>e.getAttribute("id")===o.stream.oe().name));if(e.length>1)throw new ReferenceError(`Unable to resolve expression "${i.getAttribute("value")}". Duplicate ID "${o.stream.oe().name}".`);if(0===e.length)throw new ReferenceError(`Unable to resolve expression "${i.getAttribute("value")}". "${o.stream.oe().name}" is undefined.`);a.push(e[0]),e[0].parentNode.removeChild(e[0]),t=t.slice(0,t.indexOf(e[0])).concat(t.slice(t.indexOf(e[0])+1))}}}}static#g(e,t){t.forEach((e=>{e.previousSibling.tagName||""!==e.previousSibling.nodeValue.trim()||e.parentNode.removeChild(e.previousSibling),e.parentNode.removeChild(e)})),e.$e=t.reduce(((t,r)=>{let n=r.getAttribute("id");if(n in t)throw new Error(`Duplicate segment ID: "${n}"`);if(n in e.unit)throw new Error(`Segment ID: "${n}" already defined as a unit`);return t[r.getAttribute("id")]=r.getAttribute("d"),t}),{})}#y(e){let t,r=[];do{t=Array.from(this.document.getElementsByTagName("include")),t.forEach((t=>{let n=t.getAttribute("href");if(-1!==r.indexOf(n))throw new Error(`Circular include reference: ${n}`);r.push(n),n=n.split("#");let i=n[0],a=n.length>1?n.slice(1).join("#"):null;const s=require("fs").Me(e.Ie+i,{encoding:"utf-8",De:"r"});let c,l=o.#x(s);if(null!==a){if(c=l.getElementById(a),!c)throw new Error(`Failed to include file: ${i}, ID: ${a}`)}else if(c=l.documentElement,!c)throw new Error(`Failed to include file: ${i}`);if("svg"===c.nodeName.toLowerCase()){let e=c.firstChild;for(;e;){let r=e;e=e.nextSibling,t.parentNode.insertBefore(r,t)}}else{let e=c;for(;e;){let r=e;e=e.nextSibling,t.parentNode.insertBefore(r,t)}}t.parentNode.removeChild(t)}))}while(t.length)}static#b(e,t){const r=e.cloneNode(!0);for(Array.from(r.getElementsByTagName("*")).forEach((e=>Array.from(e.attributes).forEach((e=>Object.entries(t).forEach((([t,r])=>e.value=e.value.replaceAll(t,r))))))),r.firstChild&&!r.firstChild.tagName&&""===r.firstChild.nodeValue.trim()&&r.removeChild(r.firstChild);r.firstChild;)e.parentNode.insertBefore(r.firstChild,e)}static#R(e,t){return t.length&&t==="f".repeat(t.length)?e.toString(16).padStart(t.length,"0"):t==="0".repeat(t.length)?e.toString().padStart(t.length,"0"):e.toString()}static#T(e,t){let r=t.getElementsByTagName("template")[0];for(;r;){if("repeat"===r.getAttribute("type")){let t=parseInt(a.ye(e,r.getAttribute("start")))||0,n=parseInt(a.ye(e,r.getAttribute("stop")))||0,i=parseInt(a.ye(e,r.getAttribute("step")))||1,s=parseInt(a.ye(e,r.getAttribute("column-count")))||0,c=t<n?t:n,l=t>n?t:n,h=r.getAttribute("v-map").split(new RegExp("\\s*,\\s*","g")).filter((e=>""!==e)).map((e=>{let[t,r]=e.split(new RegExp("\\s*:\\s*","g"));return t=t.split("-"),t.length<2?t[1]=t[0]:t.length>2&&(t=t.slice(0,2)),t=t.map(((e,t)=>"*"===e||""===e?0===t?c:l:parseInt(e)||0)),{start:t[0],stop:t[1],value:r??""}})),u=r.getAttribute("i-format")??"",p=r.getAttribute("v-format")??"",f=r.getAttribute("x-format")??"",w=r.getAttribute("y-format")??"",m=Math.floor(t/s),d=t-m*s;for(let e=t;e<=n;e+=i){let t=h.find((t=>e>=t.start&&e<=t.stop))?.value??e;o.#b(r,{Ye:o.#R(d,f),Le:o.#R(m,w),Ce:o.#R(e,u),ze:o.#R(t,p)}),d++,d===s&&(d=0,m++)}["start","stop","column-count"].forEach((e=>{r.setAttribute("d")}))}r.parentNode.removeChild(r),r=t.getElementsByTagName("template")[0]}}#$(e,t,r){const n=require("path");return r.filter((e=>e.hasAttribute("id"))).map((r=>{let i=e.cloneNode(!0),a=i.firstChild,s=null,o=[];for(;a;)if(!a.firstChild||o.includes(a.firstChild)){let e=a.nextSibling??a.parentNode;if(a.tagName&&a.hasAttribute("id")){let e=a;for(;e&&"defs"!==e.tagName;)e=e.parentNode;if(e)o.push(a);else if(a.getAttribute("id")!==r.getAttribute("id")||null!==s){let e=a.parentNode;a.previousSibling&&!a.previousSibling.tagName&&""===a.previousSibling.nodeValue.trim()&&e.removeChild(a.previousSibling),e.removeChild(a)}else null===s&&(s=a,s.removeAttribute("id")),o.push(a)}else o.push(a);a=e}else a=a.firstChild;const c=[];if(s){for(;s&&!s.hasAttribute("dir");)c.push(s),s=s.parentNode;if(s)if(1===s.attributes.length&&s.parentNode){const e=s.parentNode;e.insertBefore(c[c.length-1],s),e.removeChild(s)}else s.removeAttribute("dir")}else i=null;return[t+(s?s.getAttribute("dir")+n.Be:"")+r.getAttribute("id")+".svg",i]})).filter((([,e])=>null!==e))}transform(e){let t={unit:{},ve:1,xe:{path:{precision:e.precision,de:e.qe},Fe:{We:"xml"===e.We||"all"===e.We,Ve:e.Ve}}};this.#y(e),o.#E(t,Array.from(this.document.getElementsByTagName("unit")));for(let r in e.unit)t.unit[r]=e.unit[r];o.#g(t,Array.from(this.document.getElementsByTagName("segment"))),o.#T(t,this.document);let r=Array.from(this.document.getElementsByTagName("path"));for(t.ve=0;r.length;){let e=r.shift(),i=new a(new n(e.getAttribute("d"))).parse(t);e.setAttribute("d",a.ge(i,t.xe.path.precision))}[{tagName:"svg",Xe:[{name:"viewBox",He:4},"width","height"]},{tagName:"rect",Xe:["x","y","width","height","rx","ry"]},{tagName:"circle",Xe:["r","cx","cy"]},{tagName:"ellipse",Xe:["rx","ry","cx","cy"]},{tagName:"line",Xe:["x1","y1","x2","y2"]},{tagName:"image",Xe:["x","y","width","height"]},{tagName:"pattern",Xe:["width","height"]},{tagName:"polygon",Xe:[{name:"points",He:-1}]},{tagName:"polyline",Xe:[{name:"points",He:-1}]},{tagName:"line",Xe:["x1","y1","x2","y2"]},{tagName:"textPath",Xe:["startOffset"]},{tagName:"path",Xe:["stroke-width"]},{tagName:"image",Xe:["x","y","width","height"]},{tagName:"marker",Xe:["markerWidth","markerHeight","refX","refY"]}].forEach((e=>{for(r=Array.from(this.document.getElementsByTagName(e.tagName)),t.ve=0;r.length;){let n=r.shift();e.Xe.forEach((e=>{let r;r="string"==typeof e?e:e.name,n.hasAttribute(r)&&n.setAttribute(r,a.ye(t,n.getAttribute(r)))}))}}));let i=[],s=this.document.documentElement.firstChild,c=8,l=3;for(;i.length||s;){s.firstChild&&i.push(s.firstChild);let e=s;s=s.nextSibling?s.nextSibling:i.pop(),t.xe.Fe.We&&e.nodeType===l&&0===e.nodeValue.replace(new RegExp("\\s+","g"),"").length&&e.parentNode.removeChild(e),t.xe.Fe.Ve&&e.nodeType===c&&e.parentNode.removeChild(e)}if(e.Ge){const t=require("path");let n=e.destination+t.Be;r=this.#$(this.document.documentElement,n,Array.from(this.document.getElementsByTagName("*")))}else r=[[e.destination,this.document.documentElement]];return r.map((([e,t])=>[e,(new("undefined"==typeof XMLSerializer?require("xmldom").XMLSerializer:XMLSerializer)).serializeToString(t)]))}}!function(){let e=Date.now(),t=process.argv.slice(2),r=!0,n=!0,i=["path","xml","all"],a={We:null,Ve:!1,qe:!1,precision:3};for(;n&&r&&t[0]&&t[0].startsWith("--");)switch(t[0]){case"--precision":a.precision=parseInt(t[1]),a.precision.toString()!==t[1]||isNaN(a.precision)?(console.log("Invalid syntax for --precision switch"),r=!1):t=t.slice(2);break;case"--stripWhitespace":a.We=t[1],-1===i.indexOf(a.We)?(console.log("Invalid syntax for --stripWhitespace switch"),r=!1):t=t.slice(2);break;case"--stripComments":a.Ve=!0,t.shift();break;case"--combinePathCommands":a.qe=!0,t.shift();break;case"--extract":a.Ge=!0,t.shift();break;case"--report":a.Ke=!0,t.shift();break;case"--":t.shift();default:n=!1}if(!r||t.length<2)console.log('\nUsage: npm start -- [options] <source> <destination> [units...]\n\nsource       An unprocessed SVG file containing Pather commands\ndestination  Desired filename of the processed output\noptions      One or more of the following switches:\n  --precision <n>                   Write numbers to the output with N decimal places. Default is 3\n  --stripWhitespace <path|xml|all>  Strip whitespace from within path data, between XML tags or both (all)\n  --stripComments                   Strip XML comments from the output document\n  --combinePathCommands             Combine repeated commands in path data, e.g. h 30 h 30 becomes h 60\n  --extract                         Extract all elements with an ID to individual files (destination is a directory)\n  --report                          Report information before and after processing a file\nunits        Variable values to be passed to the Pather environment\n             Name/value pairs separated by "=", e.g. myUnit=3 myOtherUnit=4.2\n');else{let r=t.shift();for(a.destination=t.shift(),a.Ke&&console.log(`Processing "${r}"...`),a.unit={},n=!0;n&&t.length;){let e,r=t.shift().split("=");switch(!0){case 2!==r.length:e=`Invalid unit format "${r.join("=")}".`;break;case null===new RegExp("^[bdefgijknopruwxy]|[a-z_$][a-z0-9_$]+$","i").exec(r[0]):e=`Invalid unit name "${r[0]}".`;break;case parseFloat(r[1]).toString()!==r[1].substr(0,parseFloat(r[1]).toString().length)||isNaN(parseFloat(r[1]))||parseFloat(r[1])===1/0||parseFloat(r[1])===-1/0:e=`Invalid unit value "${r[1]}".`}e?(console.log(`${e} Expected valid identifier followed by a number, e.g. myUnit=3`),n=!1):a.unit[r[0]]=parseFloat(r[1])}if(n){const t=require("fs"),n=require("path");a.Ie=n.je(r)+n.Be;const i=t.Me(r,{encoding:"utf-8",De:"r"});new o(i).transform(a).forEach((([e,r])=>{t.Ze(n.je(e))||t.Je(n.je(e),{Qe:!0}),t.et(e,r,{encoding:"utf-8"})})),a.Ke&&console.log(`Completed successfully in ${Date.now()-e} ms\n`)}}}()}));
//# sourceMappingURL=pather.min.js.map
